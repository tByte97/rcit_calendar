<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="static/icon_logo.png">
    <title>–†—ñ–∑–¥–≤—è–Ω–∏–π –ö–∞–ª–µ–Ω–¥–∞—Ä</title>

    <link rel="stylesheet" href="./static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&family=Open+Sans:wght@400;600;700&family=Pacifico&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2.0.6/tsparticles.slim.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    

</head>

<body oncontextmenu="return false" onselectstart="return false" ondragstart="return false">

    <script>window.GOOGLE_CLIENT_ID = "{{GOOGLE_CLIENT_ID}}";</script>

    <div x-data="adventCalendar()" class="w-full h-full">
        <div id="tsparticles"></div>
        <div class="landscape">
            <div class="trees-layer">
                <svg class="tree" viewBox="0 0 100 150"><path d="M50 0 L90 120 L10 120 Z" /></svg>
                <svg class="tree" viewBox="0 0 100 150" style="animation-delay: 1s"><path d="M50 0 L100 110 L0 110 Z" /></svg>
                <div style="flex-grow: 1"></div>
                <svg class="tree" viewBox="0 0 100 150" style="animation-delay: 2s"><path d="M50 10 L80 130 L20 130 Z" /></svg>
                <svg class="tree" viewBox="0 0 100 150" style="animation-delay: 0.5s"><path d="M50 0 L90 120 L10 120 Z" /></svg>
            </div>
            <svg class="snowdrifts" viewBox="0 0 1440 320" preserveAspectRatio="none">
                <path fill-opacity="1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,261.3C960,256,1056,224,1152,197.3C1248,171,1344,149,1392,138.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
            </svg>
        </div>

        <header>
            <div class="header-content">
                <a href="http://rcit.ukr.education" target="_blank" class="logo-link" title="–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç –∫–æ–ª–µ–¥–∂—É">
                    <img src="/static/logo.png" alt="IT College Logo" class="header-logo-img" 
                         onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\'color:white; font-weight:bold;\'>IT COLLEGE</span>'">
                </a>
            </div>
        </header>

        <main>
            <h1 class="calendar-title">–†—ñ–∑–¥–≤—è–Ω–∏–π –ö–∞–ª–µ–Ω–¥–∞—Ä</h1>
            <div class="slogan">–í—ñ–¥–∫—Ä–∏–≤–∞–π –ø–æ–¥–∞—Ä—É–Ω–∫–∏ –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è!</div>

            <div class="auth-container">
                <div x-show="!googleToken" style="text-align: center;" x-cloak>
                    <div style="margin-bottom: 10px; font-weight: bold;">–£–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ –ø–æ—à—Ç—É –∫–æ–ª–µ–¥–∂—É:</div>
                    <div id="google_btn"></div>
                </div>
                <div x-show="googleToken" class="user-info" x-cloak>
                    –ü—Ä–∏–≤—ñ—Ç, <span class="user-email" x-text="userEmail"></span>! üëã<br>
                    <button class="logout-btn" @click="logout()">–í–∏–π—Ç–∏</button>
                </div>
            </div>

            <div class="grid" :class="{ 'blur': !googleToken }">
                <template x-for="day in totalDays" :key="day">
                    <div class="cell"
                         :class="{
                            'locked future': isLocked(day),
                            'past': isPast(day),
                            'today': isToday(day),
                            'opened': isOpened(day)
                         }"
                         @click="handleDayClick(day)">
                        <div class="cell-number" x-text="day"></div>
                        <div class="cell-icon"></div>
                    </div>
                </template>
            </div>
        </main>

        <div class="modal-overlay" :class="{ 'active': showModal }">
            <div class="modal" @click.away="showModal = false">
                <div class="modal-title" x-text="modalTitle"></div>
                <div class="modal-message">
                    <template x-if="isLoading"><span>‚ùÑÔ∏è –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ...</span></template>
                    <template x-if="!isLoading">
                        <div>
                            <div x-text="modalMessage"></div>
                            <div x-show="modalPrize" class="prize-box" x-text="modalPrize"></div>
                        </div>
                    </template>
                </div>
                <button class="close-btn" @click="showModal = false">–ó—Ä–æ–∑—É–º—ñ–ª–æ</button>
            </div>
        </div>
    </div>
    
<script>
        // –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞ (F12)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || (e.ctrlKey && e.key === 'u') || (e.ctrlKey && e.shiftKey && e.key === 'i') || (e.ctrlKey && e.key === 'c')) { e.preventDefault(); return false; }
        });

        document.addEventListener('alpine:init', () => {
            Alpine.data('adventCalendar', () => ({
                totalDays: 24,
                apiUrl: '', // URL –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
                
                showModal: false,
                modalTitle: '',
                modalMessage: '',
                modalPrize: null,
                isLoading: false,
                
                // 1 - –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è (–≥—Ä—É–¥–µ–Ω—å), null - –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
                currentDay: 5, 
                
                clickedDays: [],
                googleToken: null,
                userEmail: '',

                init() {
                    this.googleToken = localStorage.getItem('googleToken');
                    this.userEmail = localStorage.getItem('userEmail');
                    
                    const now = new Date();
                    if (this.currentDay === null) {
                        const month = now.getMonth();
                        if (month === 11) this.currentDay = now.getDate(); 
                        else if (month < 11) this.currentDay = 0;
                        else this.currentDay = 25; 
                    }

                    if (!this.googleToken) { 
                    } else {
 
                        this.syncHistory();
                    }
                },

                async syncHistory() {
                    if (!this.googleToken) return;
                    try {
                        const response = await fetch(`${this.apiUrl}/get-history`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: this.googleToken })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();

                            if (Array.isArray(data)) {
                                this.clickedDays = data;
                            } else if (data.opened_days) {
                                this.clickedDays = data.opened_days;
                            }
                        } else if (response.status === 401) {
                            this.logout();
                        }
                    } catch (e) {
                        console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é:", e);
                    }
                },

                renderGoogleButton() {
                    const checkGoogle = setInterval(() => {
                        if (window.google && window.GOOGLE_CLIENT_ID) {
                            clearInterval(checkGoogle);
                            google.accounts.id.initialize({
                                client_id: window.GOOGLE_CLIENT_ID,
                                callback: (response) => this.handleGoogleLogin(response)
                            });
                            google.accounts.id.renderButton(
                                document.getElementById("google_btn"),
                                { theme: "outline", size: "large", width: 250 }
                            );
                        }
                    }, 500);
                },

                handleGoogleLogin(response) {
                    const token = response.credential;
                    
                    try {
                        const base64Url = token.split('.')[1];
                        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                        
                        const jsonPayload = atob(base64);
                        const payload = JSON.parse(jsonPayload);
                        
                        if (payload.email.endsWith("@rcit.ukr.education")) {
                            this.googleToken = token;
                            this.userEmail = payload.email;
                            
                            localStorage.setItem('googleToken', token);
                            localStorage.setItem('userEmail', payload.email);
                            
                            this.syncHistory(); 
                            
                        } else {
                            alert("–î–æ—Å—Ç—É–ø –¥–æ–∑–≤–æ–ª–µ–Ω–æ –ª–∏—à–µ –¥–ª—è –ø–æ—à—Ç–∏ @rcit.ukr.education!");
                            this.logout(); 
                        }

                    } catch (e) {
                        console.error("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ç–æ–∫–µ–Ω–∞:", e);
                        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è —É–≤—ñ–π—Ç–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.");
                    }
                },

                logout() {
                    this.googleToken = null;
                    this.userEmail = null;
                    this.clickedDays = [];
                    localStorage.removeItem('googleToken');
                    localStorage.removeItem('userEmail');
                    setTimeout(() => this.renderGoogleButton(), 100);
                },

                isLocked(day) { return day > this.currentDay; },
                isPast(day) { return day < this.currentDay; },
                isToday(day) { return day === this.currentDay; },
                isOpened(day) { return this.clickedDays.includes(day); },

                async handleDayClick(day) {
                    if (!this.googleToken) { alert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä!"); return; }
                    
                    if (this.isLocked(day)) { 
                        this.presentModal("–©–µ —Ä–∞–Ω–æ üîí", "–¶–µ–π –¥–µ–Ω—å –Ω–∞—Å—Ç–∞–Ω–µ –ø—ñ–∑–Ω—ñ—à–µ."); 
                        return; 
                    }
                    
                    this.isLoading = true;
                    this.showModal = true;
                    this.modalTitle = "–í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ...";
                    this.modalMessage = "";
                    this.modalPrize = null;

                    try {
                        const response = await fetch(`${this.apiUrl}/try-luck`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ day: day, token: this.googleToken })
                        });
                        
                        if (response.status === 401) {
                            this.logout();
                            this.showModal = false;
                            alert("–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å. –£–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.");
                            return;
                        }

                        const data = await response.json();
                        this.isLoading = false;
                        
                        if (response.status === 200 || ['WIN_PRIZE', 'INFO', 'ALREADY_OPENED'].includes(data.status)) {
                            this.presentModal(data.title || "–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è", data.message, data.prize);
                            
                            if (!this.clickedDays.includes(day)) {
                                this.clickedDays.push(day);
                            }
                            
                            if (data.status === 'WIN_PRIZE') {
                                 if (typeof confetti === 'function') {
                                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                                 }
                            }
                        } else {
                            this.presentModal("–£–≤–∞–≥–∞", data.message);
                        }

                    } catch (e) {
                        this.isLoading = false;
                        this.presentModal("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è", "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≤'—è–∑–∞—Ç–∏—Å—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º.");
                    }
                },

                presentModal(title, message, prize = null) {
                    this.modalTitle = title;
                    this.modalMessage = message;
                    this.modalPrize = prize;
                    this.showModal = true;
                }
            }));
        });

               document.addEventListener("DOMContentLoaded", async () => {
            await tsParticles.load('tsparticles', {
                particles: {
                    color: { value: "#ffffff" },
                    move: { enable: true, speed: 1.5, direction: "bottom", random: true },
                    number: { value: 100, density: { enable: true, area: 800 } },
                    opacity: { value: 0.7, random: true },
                    shape: { type: "circle" },
                    size: { value: { min: 1, max: 4 } },
                },
                interactivity: {
                    events: { onHover: { enable: true, mode: "repulse" } },
                    modes: { repulse: { distance: 100, duration: 0.4 } }
                },
                background: { opacity: 0 }
            });
        });
    </script>
</body>
</html>